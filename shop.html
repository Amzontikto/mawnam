<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ - Mawnam Studio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(circle, #ff0000, #000000 80%);
      color: #fff;
      margin: 0;
      padding: 20px;
      text-align: center;
      min-height: 100vh;
    }
    h2 {
      color: #ff4d4d;
      margin-bottom: 20px;
    }
    .box {
      background: rgba(0,0,0,0.6);
      border: 2px solid #ff3333;
      border-radius: 12px;
      padding: 25px;
      margin: 20px auto;
      max-width: 400px;
    }
    button {
      background: #ff3333;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
      transition: background 0.3s;
    }
    button:hover {
      background: #cc0000;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #00ffcc;
    }
    #itemImg {
      margin-top: 15px;
      max-width: 200px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>üéÅ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <div class="box">
    <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°</p>
    <button onclick="openBox()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á (50 ‡∏ö‡∏≤‡∏ó)</button>
    <div id="result"></div>
    <img id="itemImg" alt="item">
  </div>

  <script>
    function openBox() {
      let currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        window.location.href = "login.html";
        return;
      }

      if (!currentUser.balance || currentUser.balance < 50) {
        alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô");
        return;
      }

      let products = JSON.parse(localStorage.getItem("products")) || [];
      if (products.length === 0) {
        alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        return;
      }

      // ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô
      currentUser.balance -= 50;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å balance ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà users ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      let users = JSON.parse(localStorage.getItem("users")) || [];
      let idx = users.findIndex(u => u.username === currentUser.username);
      if (idx !== -1) {
        users[idx].balance = currentUser.balance;
        localStorage.setItem("users", JSON.stringify(users));
      }

      // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ (chance)
      let totalChance = products.reduce((sum, p) => sum + Number(p.chance), 0);
      let rand = Math.random() * totalChance;
      let cumulative = 0;
      let selected = null;

      for (let p of products) {
        cumulative += Number(p.chance);
        if (rand <= cumulative) {
          selected = p;
          break;
        }
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      let resultDiv = document.getElementById("result");
      let imgEl = document.getElementById("itemImg");

      resultDiv.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: " + selected.name + " üéâ";
      imgEl.src = selected.image;
      imgEl.style.display = "block";

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
      let purchaseHistory = JSON.parse(localStorage.getItem("purchaseHistory")) || [];
      purchaseHistory.push({
        username: currentUser.username,
        item: selected.name,
        image: selected.image,
        date: new Date().toLocaleString()
      });
      localStorage.setItem("purchaseHistory", JSON.stringify(purchaseHistory));
    }
  </script>
</body>
</html>